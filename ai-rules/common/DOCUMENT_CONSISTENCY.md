# ドキュメント整合性確認ガイドライン

**プロジェクト横断**: このファイルは複数プロジェクトで共通利用可能な汎用ガイドラインです。

**最終更新**: 2025-10-08

このドキュメントでは、プロジェクト全体のドキュメント整合性を確保するためのチェックタイミングと手順を定義します。

---

## 📋 目次

1. [整合性確認が必要な理由](#整合性確認が必要な理由)
2. [確認タイミング](#確認タイミング)
3. [整合性確認チェックリスト](#整合性確認チェックリスト)
4. [実施手順](#実施手順)
5. [よくある不整合パターン](#よくある不整合パターン)

---

## 🎯 整合性確認が必要な理由

### ドキュメント不整合のリスク

1. **開発者の混乱**: 矛盾する情報により作業が滞る
2. **品質低下**: 古い情報に基づいた実装が行われる
3. **保守性悪化**: どのドキュメントが正しいか判断できない
4. **オンボーディング遅延**: 新メンバーが正しい情報を見つけられない

### 整合性確保の効果

- ✅ 一貫した開発フロー
- ✅ 迅速な意思決定
- ✅ 新メンバーの即戦力化
- ✅ 技術的負債の削減

---

## ⏰ 確認タイミング

### 1️⃣ 必須タイミング（変更時）

#### ワークフロー変更時（最重要）

**トリガー**:
- 開発フロー変更（例: サブエージェント追加、Issue管理ルール変更）
- ブランチ戦略変更
- レビュープロセス変更

**確認対象**:
- [ ] CLAUDE.md（トップレベルフロー図）
- [ ] common/WORKFLOW.md（汎用フロー）
- [ ] nissei/WORKFLOW.md（プロジェクト固有フロー）
- [ ] .claude/agents/（サブエージェント定義）
- [ ] 関連するai-rules/（影響を受けるガイドライン）

**確認手順**: [ワークフロー変更時チェックリスト](#ワークフロー変更時)

---

#### サブエージェント追加時

**トリガー**:
- 新しいサブエージェント作成（例: docs-updater, e2e-tester）
- 既存サブエージェントの役割変更

**確認対象**:
- [ ] CLAUDE.md（サブエージェント一覧セクション）
- [ ] .claude/agents/（新規ファイル作成）
- [ ] nissei/WORKFLOW.md（サブエージェント使用箇所）
- [ ] nissei/PR_AND_REVIEW.md（レビューフロー）
- [ ] ai-rules/README.md（サブエージェント説明）

**確認手順**: [サブエージェント追加時チェックリスト](#サブエージェント追加時)

---

#### Issue/PR管理ルール変更時

**トリガー**:
- Issue作成ルール変更（例: その場で即修正原則）
- PR作成フォーマット変更
- レビュー基準変更

**確認対象**:
- [ ] CLAUDE.md（作業終了時セクション）
- [ ] common/ISSUE_GUIDELINES.md（汎用ルール）
- [ ] nissei/ISSUE_GUIDELINES.md（プロジェクト固有ルール）
- [ ] nissei/WORKFLOW.md（レビュー対応フロー）
- [ ] .claude/agents/code-reviewer.md（レビュー基準）

**確認手順**: [Issue/PR管理ルール変更時チェックリスト](#issuepr管理ルール変更時)

---

#### ドキュメント構造変更時

**トリガー**:
- ai-rules/内のファイル追加・削除・移動
- ディレクトリ構造変更
- Serenaメモリファイル追加・削除

**確認対象**:
- [ ] ai-rules/README.md（ディレクトリ構造図）
- [ ] CLAUDE.md（リンク集）
- [ ] 全ai-rulesファイル（相互参照リンク）
- [ ] nissei/DOCUMENTATION_GUIDE.md（Serenaメモリ一覧）

**確認手順**: [ドキュメント構造変更時チェックリスト](#ドキュメント構造変更時)

---

#### フェーズ完了時

**トリガー**:
- Phase完了（例: Phase 3完了）
- マイルストーン達成

**確認対象**:
- [ ] docs/PHASES.md（フェーズ一覧・完了マーク）
- [ ] .serena/memories/phase_progress.md（進捗記録）
- [ ] .serena/memories/implementation_status.md（実装状況）
- [ ] docs/README.md（プロジェクト状態）

**確認手順**: [common/PHASE_MANAGEMENT.md](./PHASE_MANAGEMENT.md)

---

### 2️⃣ 推奨タイミング（定期的）

#### 月次レビュー（メンテナンス）

**目的**: 累積した小さな不整合を解消

**実施内容**:
1. リンク切れチェック（全ドキュメント）
2. 古い情報の特定（3ヶ月以上未更新）
3. 矛盾する記述の発見
4. 不要なファイルの削除

**確認手順**: [月次レビュー手順](#月次レビュー手順)

---

#### 新メンバー参加時

**目的**: オンボーディング前にドキュメント品質を確保

**実施内容**:
1. セットアップ手順の検証
2. クイックスタートガイドの動作確認
3. リンクの有効性確認
4. 用語集の最新性確認

---

## ✅ 整合性確認チェックリスト

### ワークフロー変更時

#### 1. CLAUDE.md 確認
- [ ] フロー図が最新か
- [ ] サブエージェント一覧が正しいか
- [ ] ai-rules/へのリンクが正しいか
- [ ] 基本ルール（ポート・命名）が最新か

#### 2. common/WORKFLOW.md 確認
- [ ] 汎用フローが最新か
- [ ] プロジェクト固有情報が含まれていないか
- [ ] 他プロジェクトでも利用可能か

#### 3. nissei/WORKFLOW.md 確認
- [ ] nissei固有フローが最新か
- [ ] common/WORKFLOW.mdを正しく参照しているか
- [ ] サブエージェント使用箇所が正しいか
- [ ] Issue管理ガイドラインへのリンクが正しいか

#### 4. .claude/agents/ 確認
- [ ] 各サブエージェントファイルが最新か
- [ ] description が正確か
- [ ] tools リストが正しいか
- [ ] ワークフロー記述と整合しているか

#### 5. 影響を受けるai-rules/ファイル確認
- [ ] PR_AND_REVIEW.md
- [ ] TESTING.md
- [ ] DOCUMENTATION_GUIDE.md
- [ ] ISSUE_GUIDELINES.md

---

### サブエージェント追加時

#### 1. 新規サブエージェントファイル作成
- [ ] `.claude/agents/<name>.md` を作成
- [ ] フロントマター（name, description, tools, model）を記載
- [ ] 役割と責任を明確に定義
- [ ] 出力形式を定義
- [ ] 重要な注意事項を記載

#### 2. CLAUDE.md 更新
- [ ] サブエージェントセクションに追加
  - 用途
  - 実行タイミング
  - 評価基準（該当する場合）
  - 設定ファイルへのリンク
- [ ] フロー図に追加（該当する場合）
- [ ] 関連ドキュメントへのリンク追加

#### 3. nissei/WORKFLOW.md 更新
- [ ] サブエージェント使用箇所を追加
- [ ] 実行タイミングを明記
- [ ] 前後の作業フローを明確化

#### 4. ai-rules/README.md 更新
- [ ] サブエージェント一覧に追加
- [ ] ドキュメント関係図に追加

#### 5. 関連ドキュメント更新
- [ ] nissei/PR_AND_REVIEW.md（レビュー関連の場合）
- [ ] nissei/TESTING.md（テスト関連の場合）
- [ ] nissei/DOCUMENTATION_GUIDE.md（ドキュメント関連の場合）

---

### Issue/PR管理ルール変更時

#### 1. 汎用ルール更新（該当する場合）
- [ ] common/ISSUE_GUIDELINES.md を更新
- [ ] 他プロジェクトでも適用可能か確認

#### 2. プロジェクト固有ルール更新
- [ ] nissei/ISSUE_GUIDELINES.md を更新
- [ ] common/を正しく参照しているか確認
- [ ] プロジェクト固有の方針を明記

#### 3. CLAUDE.md 更新
- [ ] 作業終了時セクションを更新
- [ ] 基本ルールセクションを更新（該当する場合）

#### 4. nissei/WORKFLOW.md 更新
- [ ] レビュー対応フローを更新
- [ ] Issue管理ガイドラインへのリンクを追加

#### 5. サブエージェント更新
- [ ] .claude/agents/code-reviewer.md を更新
- [ ] レビュー結果形式を更新
- [ ] 重要な注意事項に新方針を追記

#### 6. 関連ドキュメント確認
- [ ] nissei/PR_AND_REVIEW.md
- [ ] nissei/TESTING.md（該当する場合）
- [ ] nissei/DOCUMENTATION_GUIDE.md（該当する場合）

---

### ドキュメント構造変更時

#### 1. ai-rules/README.md 更新
- [ ] ディレクトリ構造図を更新
- [ ] ファイル一覧を更新
- [ ] ドキュメント関係図を更新

#### 2. CLAUDE.md 更新
- [ ] リンク集を更新
- [ ] 削除されたファイルへのリンクを削除
- [ ] 新規ファイルへのリンクを追加

#### 3. 全ai-rulesファイルのリンク確認
- [ ] 相互参照リンクが有効か
- [ ] 削除されたファイルへのリンクはないか
- [ ] 新規ファイルへのリンクが必要か

#### 4. nissei/DOCUMENTATION_GUIDE.md 更新（Serenaメモリ変更時）
- [ ] Serenaメモリ一覧を更新
- [ ] 役割と更新タイミングを記載
- [ ] 例を更新

---

## 🔧 実施手順

### ワークフロー変更の実施手順

```bash
# 1. 変更対象ファイルをリストアップ
影響を受けるファイル:
- CLAUDE.md
- ai-rules/common/WORKFLOW.md
- ai-rules/nissei/WORKFLOW.md
- .claude/agents/*.md
- ai-rules/nissei/PR_AND_REVIEW.md

# 2. 各ファイルを順次確認・更新
# - 変更内容を反映
# - リンクの有効性確認
# - 用語の統一確認

# 3. 整合性チェック実施
# - 本ガイドラインのチェックリストに従う
# - すべての項目をチェック

# 4. 変更をコミット
git add CLAUDE.md ai-rules/ .claude/
git commit -m "docs: ワークフロー変更に伴うドキュメント整合性確保"

# 5. 最終確認
# - 変更されたファイル間の整合性を再確認
# - リンク切れがないか確認
```

---

### 月次レビュー手順

```bash
# 1. リンク切れチェック
# 全.mdファイルの相互参照リンクを確認

# 2. 古い情報の特定
# 3ヶ月以上未更新のファイルを特定
find ai-rules/ docs/ -name "*.md" -mtime +90

# 3. Serenaメモリと実装の整合性確認
mcp__serena__list_memories
# 各メモリが実装状況と一致しているか確認

# 4. docs/ と Serenaメモリの整合性確認
# - docs/DATABASE.md ⟷ .serena/memories/database_specifications.md
# - docs/API.md ⟷ .serena/memories/api_specifications.md

# 5. 不要なファイルの削除
# - 重複したドキュメント
# - 古いバックアップファイル
# - 未使用のテンプレート

# 6. 変更をコミット
git add -A
git commit -m "docs: 月次ドキュメントレビュー・整合性確保"
```

---

## ⚠️ よくある不整合パターン

### パターン1: サブエージェント追加時の更新漏れ

**問題**:
- `.claude/agents/`に新ファイルを作成
- CLAUDE.mdに記載を忘れる
- ワークフロー図に追加を忘れる

**対策**:
- サブエージェント追加時チェックリストを必ず使用
- CLAUDE.md, nissei/WORKFLOW.md, ai-rules/README.mdの3ファイルは必ず更新

---

### パターン2: common/ と nissei/ の重複

**問題**:
- common/に記載すべき汎用ルールをnissei/に記載
- nissei/固有情報をcommon/に記載

**対策**:
- 「他プロジェクトでも使えるか」を基準に判断
- 使える → common/
- 使えない（nissei固有） → nissei/

---

### パターン3: リンク切れ

**問題**:
- ファイル移動時にリンクを更新し忘れる
- ファイル削除時にリンク元を更新し忘れる

**対策**:
- ファイル移動・削除前にGrepでリンク元を検索
- `grep -r "削除予定ファイル名" ai-rules/ CLAUDE.md`

---

### パターン4: Serenaメモリと docs/ の不一致

**問題**:
- 実装変更後、Serenaメモリのみ更新
- docs/が古い情報のまま放置

**対策**:
- PRマージ後、docs-updaterサブエージェントを必ず実行
- 仕様確定時のみdocs/を更新（一時的な変更はSerenaメモリのみ）

---

### パターン5: フロー図と実際のワークフローの乖離

**問題**:
- CLAUDE.mdのフロー図が古い
- 実際の作業手順と異なる

**対策**:
- ワークフロー変更時、必ずフロー図も更新
- 月次レビューでフロー図の正確性を確認

---

## 🔗 関連ドキュメント

- [PHASE_MANAGEMENT.md](./PHASE_MANAGEMENT.md) - フェーズ完了時の整合性確認
- [WORKFLOW.md](./WORKFLOW.md) - ワークフロー変更時の影響範囲
- [DOCUMENTATION_GUIDE.md](./DOCUMENTATION_GUIDE.md) - docs/ と Serenaメモリの2層管理
- [../nissei/DOCUMENTATION_GUIDE.md](../nissei/DOCUMENTATION_GUIDE.md) - nissei固有のドキュメント管理

---

## 📝 更新履歴

- **2025-10-08**: 初版作成
  - 整合性確認タイミングの定義
  - チェックリストの作成
  - 実施手順の定義
  - よくある不整合パターンの記載
