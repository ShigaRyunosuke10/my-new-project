# Issue作成・解決ガイドライン

このドキュメントは、{{PROJECT_NAME}}プロジェクトにおけるIssue管理の統一ルールを定義します。

## Issue作成ルール

### 1. Issue作成が必要なケース

以下のいずれかに該当する場合、GitHubでIssueを作成します：

#### Critical（即座に対応が必要）
- セキュリティ脆弱性（認証バイパス、SQLインジェクション等）
- データ破損・データ損失のリスク
- システム全体の停止を引き起こす問題
- 法令・コンプライアンス違反のリスク

#### Major（早急な対応が推奨）
- 主要機能の動作不良・バグ
- パフォーマンス著しく低下させる問題
- エラーハンドリングの欠如によるクラッシュリスク
- セキュリティベストプラクティスからの逸脱

#### Minor（改善推奨）
- コード品質の改善（可読性、保守性）
- リファクタリング提案
- 軽微なバグ・UI/UXの改善
- テストカバレッジの向上
- ドキュメント不足

### 2. Issue作成タイミング

| タイミング | 詳細 |
|-----------|------|
| **code-reviewerレビュー後** | Critical/Majorの指摘事項は必ずIssue化 |
| **e2e-testerテスト失敗時** | 再現性のあるバグはIssue化 |
| **ユーザー報告** | バグ報告・機能要望を受領時 |
| **開発中の気づき** | 技術的負債・改善点の発見時 |
| **セキュリティ監査** | 脆弱性診断・コードレビューでの発見時 |

### 3. Issue作成フォーマット

```markdown
## 概要
[問題の簡潔な説明]

## 重要度
- [ ] Critical
- [ ] Major
- [ ] Minor

## 現状の問題
[具体的な問題点・エラー内容]

## 再現手順（バグの場合）
1. [ステップ1]
2. [ステップ2]
3. [期待結果 vs 実際の結果]

## 提案される解決策
[修正方針・実装案]

## 影響範囲
- 影響するファイル: [ファイル一覧]
- 影響する機能: [機能一覧]
- DB変更の有無: [あり/なし]

## 作業時間見積もり
- 調査: [X分]
- 実装: [Y分]
- テスト: [Z分]
- 合計: [約X時間]

## 関連Issue/PR
- 関連: #XX
- ブロック: #YY
```

## Issue解決ルール

### 1. code-reviewerレビュー後の対応フロー（重要）

PR作成後、code-reviewerでレビューを受けた際の対応フローを明確化します。

#### 基本方針: その場で即修正（推奨）

**原則**: 発見された問題は可能な限りその場で修正し、Issueを溜めないようにします。

```
PR作成
    ↓
code-reviewerレビュー実行
    ↓
問題発見
    ↓
┌─────────────────────────────────────┐
│ Critical問題                          │
│ → 必ずその場で修正                    │
│   （作業時間に関わらず最優先）        │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ Major問題                             │
│ → 原則その場で修正                    │
│   （30分以内の作業なら必ず）          │
│   （30分超でも可能なら修正を推奨）    │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ Minor問題                             │
│ → 5分以内なら即修正                  │
│   （それ以外もできるだけ修正）        │
└─────────────────────────────────────┘
    ↓
該当分を修正
    ↓
修正完了後、再度code-reviewerレビュー（Critical/Major修正時）
    ↓
すべて解消済みを確認
    ↓
マージ
    ↓
docs-updaterでメモリ更新
```

#### 判断基準の詳細

| 重要度 | 対応方針 | Issue化する場合 |
|--------|----------|----------------|
| **Critical** | ✅ 必ず即修正 | ❌ Issue化しない（緊急対応） |
| **Major** | ✅ 原則即修正（30分以内必須） | ⚠️ 1時間超かつ複雑な場合のみ（要相談） |
| **Minor** | ✅ 5分以内なら必ず即修正、それ以外も推奨 | ⚠️ 大規模リファクタリングのみ |

#### 作業時間と対応方針

| 作業内容 | 見積もり時間 | Critical | Major | Minor |
|---------|-------------|----------|-------|-------|
| 定数名変更・コメント追加 | 5分 | ✅ 即修正 | ✅ 即修正 | ✅ 即修正 |
| import文の整理 | 5-10分 | ✅ 即修正 | ✅ 即修正 | ✅ 即修正 |
| 型ヒント修正 | 5-10分 | ✅ 即修正 | ✅ 即修正 | ✅ 即修正 |
| エラーメッセージ修正 | 10-15分 | ✅ 即修正 | ✅ 即修正 | ✅ 即修正 |
| 簡単なバリデーション追加 | 15-20分 | ✅ 即修正 | ✅ 即修正 | ✅ 即修正 |
| ロジック修正（小規模） | 20-30分 | ✅ 即修正 | ✅ 即修正 | ✅ 推奨 |
| 新規関数追加 | 30-60分 | ✅ 即修正 | ✅ 推奨 | ⚠️ 要相談 |
| UI実装を伴う修正 | 1時間以上 | ✅ 即修正 | ⚠️ 要相談 | ⚠️ Issue化検討 |
| 複数ファイルにまたがる修正 | 1時間以上 | ✅ 即修正 | ⚠️ 要相談 | ⚠️ Issue化検討 |

#### 例外的にIssue化する場合（稀）

以下の条件を**すべて満たす場合のみ**Issue化を検討：

1. **作業時間が1時間以上**
2. **複雑な設計変更が必要**
3. **複数ファイルにまたがる大規模な修正**
4. **UI実装を伴う**
5. **ユーザーと要件確認が必要**

**Issue化の判断プロセス**:
```
1. ユーザーに相談して判断を仰ぐ
2. 緊急性を確認
3. 時間的猶予があればIssue化、なければその場で修正
```

**Issue化した場合の対応フロー**:

```
code-reviewerレビュー完了
    ↓
大規模問題を発見（1時間超の修正が必要）
    ↓
ユーザーに相談
    ├─ 緊急 → その場で修正してからマージ
    └─ 猶予あり → Issue化
        ↓
        GitHub Issueを作成
        ├─ タイトル: code-reviewerの指摘内容を要約
        ├─ 本文: ISSUE_GUIDELINES.mdのフォーマットに従う
        ├─ 重要度: Critical/Major/Minorをラベル付け
        └─ 関連PR: 「PR #XX のレビューで発見」と記載
        ↓
        Serenaメモリに登録
        ├─ current_issues_and_priorities.md に追加
        ├─ 重要度・作業時間見積もり・対応方針を記載
        └─ 「PR #XX レビュー由来」と出所を明記
        ↓
        現在のPRはマージ（Critical指摘が解消済みなら）
        ├─ PRコメントに「Issue #XX として別途対応予定」と記載
        └─ docs-updaterでメモリ更新
        ↓
        Issue対応は別セッション・別PRで実施
        ├─ 優先度判断（他のIssueとの兼ね合い）
        ├─ 専用ブランチ作成（fix-issue-XX-description）
        ├─ 実装・テスト・PR作成
        ├─ code-reviewerレビュー（再度その場で即修正方針）
        └─ マージ・Issueクローズ
```

**Issue化時の注意事項**:

1. **Issue作成時に必須記載**
   - 出所: 「PR #XX のcode-reviewerレビューで発見」
   - 重要度: Critical/Major/Minor（レビュー時の分類を維持）
   - 作業時間見積もり: 詳細に記載（1時間超の根拠）
   - 影響範囲: 修正が必要なファイル・機能の一覧
   - 対応方針: 具体的な修正案

2. **Serenaメモリ登録時の形式**
   ```markdown
   ## Issue #XX: [タイトル]
   - **重要度**: [Critical/Major/Minor]
   - **状態**: Open
   - **作業時間見積もり**: XX時間
   - **概要**: [簡潔な説明]
   - **対応方針**: [修正方針]
   - **出所**: PR #YY のcode-reviewerレビューで発見
   - **優先度**: [他のIssueとの相対的な優先度]
   ```

3. **現在のPRのマージ判断**
   - Critical指摘がすべて解消済み → マージ可
   - Major/Minor指摘のみ残存 → Issue化してマージ可
   - Critical指摘が未解消 → Issue化不可、その場で修正必須

4. **Issue対応のスケジューリング**
   - Critical Issue: 次セッションで最優先対応
   - Major Issue: 他のCritical Issueがなければ優先対応
   - Minor Issue: 他の作業との兼ね合いで柔軟に対応

#### 複数の問題がある場合の対応

**ケース1: 5-10件程度の小さな問題**
```
1. すべてその場で修正
2. 作業時間の合計が1時間以内なら一括対応
3. 一度にコミット
```

**ケース2: 10件以上の問題**
```
1. Critical/Majorを優先的に修正
2. Minorも可能な限り修正
3. 本当に大規模なもののみIssue化（ユーザー相談）
```

**ケース3: 大規模な問題が1件 + 小さな問題が複数**
```
1. 小さな問題をすべて即修正
2. 大規模な問題について相談
3. 可能なら大規模な問題も修正してからマージ
```

#### メリット

- ✅ Issueが溜まらない
- ✅ 高品質な状態でマージできる
- ✅ 後回しによる「忘れ」がない
- ✅ コンテキストスイッチのコストが低い（同じPRの作業を継続）

#### デメリットと対策

- ❌ PRマージまで時間がかかる
  - → **対策**: 小さな単位でPRを作成する習慣をつける
- ❌ 大規模な問題で詰まる可能性
  - → **対策**: Critical/Major以外は相談してIssue化も検討

### 2. 標準作業フロー（Issue化された場合）

```
Issue作成
    ↓
Serenaメモリ登録（current_issues_and_priorities.md）
    ↓
優先度判断・着手順序決定
    ↓
専用ブランチ作成（fix-issue-XX-description）
    ↓
実装・修正
    ↓
e2e-testerでテスト（必須）
    ↓
コミット・Push
    ↓
PR作成（タイトルに "Issue #XX" を含める）
    ↓
code-reviewerレビュー（必須）
    ↓
修正対応（上記フローに従う）
    ↓
マージ
    ↓
Issueクローズ
    ↓
docs-updaterでメモリ更新（必須）
```

### 3. 優先度判断基準

複数のIssueがある場合、以下の順序で優先します：

1. **重要度**: Critical → Major → Minor
2. **依存関係**: ブロッカーとなるIssueを優先
3. **作業効率**: 同じ重要度なら短時間で完了できるものから
4. **影響範囲**: 同じ重要度なら影響範囲が小さいものから

### 4. ブランチ命名規則

| Issueタイプ | ブランチ名 | 例 |
|------------|-----------|-----|
| バグ修正 | `fix-issue-XX-brief-description` | `fix-issue-55-magic-number` |
| 新機能 | `feat-issue-XX-brief-description` | `feat-issue-10-pdf-import` |
| リファクタリング | `refactor-issue-XX-brief-description` | `refactor-issue-63-regex` |
| ドキュメント | `docs-issue-XX-brief-description` | `docs-issue-20-api-spec` |
| テスト追加 | `test-issue-XX-brief-description` | `test-issue-30-e2e-login` |

### 5. PR作成ルール

#### タイトル形式
```
<type>: <brief description> (Issue #XX)
```

例:
- `fix: 管理番号のマジックナンバーを定数化 (Issue #55)`
- `refactor: 正規表現パターンの事前コンパイル化 (Issue #63)`

#### 本文に必須記載事項
- Closes #XX（自動クローズ用）
- 変更内容の要約
- テスト実施状況
- レビュー観点

### 6. Issueクローズタイミング

#### タイミング1: PR作成直後（自動クローズ設定）

PRの本文に `Closes #XX` を記載することで、**PRマージ時に自動クローズ**されます。

**推奨ケース**:
- 単一PRで完全に解決できるIssue
- 追加作業が不要なIssue
- リファクタリング・バグ修正などの明確な修正

**例**:
```markdown
## 変更内容
管理番号のマジックナンバー999を定数化しました。

Closes #55
```

#### タイミング2: マージ後の手動クローズ（条件付き）

以下のケースでは、**PRマージ後に条件確認してから手動クローズ**します：

**ケース1: ドキュメント更新が必要**
```bash
# 手順
1. PRマージ
2. docs-updaterでdocs/更新
3. 更新内容を確認
4. gh issue close XX --comment "PR #YY でマージ、ドキュメント更新完了"
```

**ケース2: 複数PRに分割されるIssue**
```bash
# 手順
1. 第1PRマージ（自動クローズなし）
2. 第2PRマージ（自動クローズなし）
3. すべてのPR完了後に手動クローズ
4. gh issue close XX --comment "PR #YY, #ZZ で完全解決"
```

**ケース3: 動作確認が必要**
```bash
# 手順
1. PRマージ
2. 本番環境/ステージング環境で動作確認
3. 問題なければクローズ
4. gh issue close XX --comment "PR #YY でマージ、本番確認完了"
```

#### タイミング3: 即座にクローズ（特殊ケース）

**ケース1: 既に解決済みと判明**
```bash
gh issue close XX --comment "PR #YY で既に解決済みでした" --reason "not_planned"
```

**ケース2: 重複Issue**
```bash
gh issue close XX --comment "#YY と重複のためクローズ" --reason "not_planned"
```

**ケース3: 対応不要と判断**
```bash
gh issue close XX --comment "検証の結果、現状の実装で問題ないと判断" --reason "not_planned"
```

### 7. Issueクローズ条件（チェックリスト）

Issueをクローズする前に、以下の全てを満たしていることを確認します：

#### 必須条件（すべてのIssue）
- [ ] 対応PRがマージ済み
- [ ] e2e-testerテスト成功（該当する場合）
- [ ] code-reviewerでCritical/Major指摘なし（またはすべて解消済み）
- [ ] Serenaメモリ更新済み（`current_issues_and_priorities.md`から削除）

#### 条件付き必須（該当する場合のみ）
- [ ] docs/配下のドキュメント更新済み（仕様変更を伴う場合）
- [ ] DB migration適用済み（DB変更を伴う場合）
- [ ] 関連Issueもすべて解決済み（依存関係がある場合）
- [ ] 本番/ステージング環境で動作確認済み（Critical Issue）

### 8. Issueクローズ方法

#### 自動クローズ（推奨）
PRの本文に以下を記載：
```markdown
Closes #XX
```

#### 手動クローズ
```bash
gh issue close XX --comment "PR #YY で解決しました"
```

## Serenaメモリ管理

### 1. Issue作成時

`current_issues_and_priorities.md` に以下の形式で追加：

```markdown
## Issue #XX: [タイトル]
- **重要度**: [Critical/Major/Minor]
- **状態**: Open
- **作業時間見積もり**: XX分
- **概要**: [簡潔な説明]
- **対応方針**: [修正方針]
```

### 2. Issue解決時

docs-updaterが以下を自動実行：

1. `current_issues_and_priorities.md` から該当Issueを削除
2. `implementation_status.md` に完了記録を追加
3. 該当する仕様メモリを更新（DB/API変更がある場合）

## 注意事項

### Issue作成時の禁止事項
- ❌ 曖昧な表現での作成（再現手順・影響範囲が不明確）
- ❌ 重複Issue作成（既存Issue検索を怠る）
- ❌ 重要度の誤判断（MinorなのにCriticalと記載等）

### Issue解決時の禁止事項
- ❌ テスト未実施でのクローズ
- ❌ レビュー未完了でのクローズ
- ❌ Serenaメモリ未更新でのクローズ
- ❌ mainブランチへの直接コミット

## サブエージェント活用

### code-reviewer
- PR作成後、必ず実行
- Critical/Major指摘は新規Issue化を検討

### e2e-tester
- コミット前、必ず実行
- テスト失敗時は修正後に再実行

### docs-updater
- マージ後、必ず実行
- Serenaメモリの整合性維持

## 関連ドキュメント

- [ワークフロー全体](./WORKFLOW.md)
- [PR・レビュープロセス](./PR_AND_REVIEW.md)
- [テストガイドライン](./TESTING.md)
- [ドキュメント管理](./DOCUMENTATION_GUIDE.md)
