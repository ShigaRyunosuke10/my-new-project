# PR & レビューガイド（汎用版）

このドキュメントでは、PR作成からレビュー、マージまでの標準プロセスを定義します。

**プロジェクト横断**: このファイルは複数プロジェクトで共通利用可能な汎用ガイドです。

**最終更新**: 2025-10-02

---

## 標準フロー

すべてのPRは以下のプロセスに従ってレビュー・マージを実施します。

```
[PR作成]
    ↓
[code-reviewer サブエージェント レビュー依頼] ← 必須
    ↓
[レビュー結果確認]
    ├─[マージ可] → [マージ] → [docs/ 更新確認] → [レビュー履歴記録]
    │
    └─[要修正] → [修正] → [push] → [再レビュー依頼] → ループ
```

---

## 1. PR作成（準備）

### 1.1 タイトル
- 簡潔に変更内容を記述
- [コミットメッセージ](./COMMIT_GUIDELINES.md) のsubjectと同じ形式
- 例: `feat: ユーザーダッシュボード画面を追加`

### 1.2 本文構成

```markdown
## 概要
この変更の目的を簡潔に説明

## 変更内容
- 具体的な変更点1
- 具体的な変更点2
- 具体的な変更点3

## テスト手順
1. 手順1
2. 手順2
3. 期待される結果

## スクリーンショット
（UI変更の場合は添付）

## 関連Issue
Closes #123
Fixes #456
```

### 1.3 PRの種類別テンプレート

#### 新機能追加

```markdown
## 概要
[機能名]を追加しました。

## 変更内容
- 機能の実装内容
- 関連するファイルの変更
- データベーススキーマの変更（あれば）

## テスト手順
1. [環境/画面]にアクセス
2. [操作手順]
3. [期待される動作]

## スクリーンショット
（あれば添付）

## 関連Issue
Closes #XXX
```

#### バグ修正

```markdown
## 概要
[バグの内容]を修正しました。

## 問題
- 発生していた問題の詳細
- 再現手順

## 原因
- 問題の根本原因

## 修正内容
- 具体的な修正内容

## テスト手順
1. 以前のバグ再現手順を実施
2. バグが解消されていることを確認

## 関連Issue
Fixes #XXX
```

#### リファクタリング

```markdown
## 概要
[対象]をリファクタリングしました。

## 目的
- リファクタリングの理由
- 改善される点

## 変更内容
- 具体的な変更内容
- 動作に変更がないこと

## テスト手順
1. 既存機能が正常に動作することを確認
2. E2Eテストがすべてパス

## 関連Issue
なし
```

### 1.4 PR作成前のチェックリスト

- [ ] 専用ブランチで作業している（`feat-`, `fix-` など）
- [ ] 動作確認が完了している
- [ ] [E2Eテスト](./TESTING.md) を実施済み
- [ ] コミットメッセージが [COMMIT_GUIDELINES.md](./COMMIT_GUIDELINES.md) に準拠
- [ ] PRテンプレートに従って記載
- [ ] 関連Issueがあればリンク（`Closes #XX`）
- [ ] スクリーンショット添付（UI変更の場合）
- [ ] `.gitignore` に機密情報が含まれていないことを確認

### 1.5 PR作成コマンド

```bash
# MCP GitHub APIを使用
mcp__github__create_pull_request
  owner: "ShigaRyunosuke10"
  repo: "nissei"
  title: "<type>: <変更内容の要約>"
  body: "
## 概要
...

## 変更内容
- ...

## テスト手順
1. ...

## 関連Issue
Closes #XX
"
  head: "<ブランチ名>"
  base: "main"
```

---

## 2. code-reviewer サブエージェント レビュー

⚠️ **重要**: PR作成直後に必ず実施

### 2.1 サブエージェントについて

`.claude/agents/code-reviewer.md` に定義された専門的なコードレビューエージェントです。

- 独立したコンテキストで動作
- GitHub API ツールに特化したアクセス
- 一貫したレビュー基準とフォーマット

### 2.2 レビュー依頼方法

PR作成後、code-reviewerサブエージェントでレビューを依頼します。

**注意**: settings.jsonでPR作成時に自動リマインダーが表示される場合があります（プロジェクト設定次第）。

**明示的な呼び出し方法**

```
> code-reviewerサブエージェントを使用してPR #[番号]をレビューしてください
```

または

```
> PR #[番号]をレビューしてください
```

（Claude Codeが適切なサブエージェントを選択します）

### 2.3 レビュー観点

- **セキュリティ**: 認証・認可、入力検証、SQLインジェクション対策
- **コード品質**: 命名規則、関数分割、DRY原則、エラーハンドリング
- **ベストプラクティス**: フレームワークの推奨パターン、パフォーマンス
- **API設計**: RESTful設計、レスポンス形式の一貫性
- **UX/UI**: 使いやすさ、アクセシビリティ
- **ドキュメント**: README、APIドキュメント、コメント

#### レビュー観点の詳細チェックリスト

**セキュリティ**
- [ ] 認証・認可が適切に実装されている
- [ ] 機密情報がハードコードされていない
- [ ] 入力値の検証が行われている
- [ ] SQLインジェクション対策がされている
- [ ] XSS（クロスサイトスクリプティング）対策がされている
- [ ] CSRF対策がされている（APIトークン認証の場合）

**パフォーマンス**
- [ ] N+1クエリが発生していない
- [ ] 不要なデータ取得をしていない
- [ ] キャッシュが適切に利用されている
- [ ] 大量データ処理でメモリリークがない
- [ ] データベースインデックスが適切に設定されている

**コード品質**
- [ ] [命名規則](./NAMING_CONVENTIONS.md) に準拠している
- [ ] 適切な関数・クラス分割がされている
- [ ] 重複コードがない（DRY原則）
- [ ] 適切なエラーハンドリングがされている
- [ ] コメントが必要な箇所に記載されている
- [ ] マジックナンバーが定数化されている
- [ ] 複雑な条件式が分かりやすく記述されている

**テスト**
- [ ] [E2Eテスト](./TESTING.md) が実装されている
- [ ] 正常系・異常系のテストがある
- [ ] エッジケースが考慮されている
- [ ] テストカバレッジが十分である
- [ ] テストが独立している（実行順序に依存しない）

**ドキュメント**
- [ ] README/ドキュメントが更新されている
- [ ] APIドキュメントが更新されている（API変更時）
- [ ] 複雑なロジックにコメントがある
- [ ] 環境変数の追加時に `.env.example` が更新されている
- [ ] データベーススキーマ変更時にマイグレーション手順が文書化されている

### 2.4 レビュー結果の分類

- **Critical（致命的）** 🔴: データ損失、セキュリティリスク、即座に修正が必要
- **Major（重要）** 🟠: パフォーマンス問題、保守性の大幅低下、マージ前または直後に修正推奨
- **Minor（軽微）** 🟡: コード品質改善、UX向上、今後の改善点として記録

---

## 3. レビュー結果の評価

code-reviewer サブエージェント からのレビュー結果を以下の基準で評価します。

### 3.1 マージ可

- **Critical問題がゼロ**
- Major問題が条件付きで許容可能
- バックエンドでのセキュリティ対策が適切

### 3.2 マージ不可（要修正）

- **Critical問題が1つ以上存在**
- Major問題が複数あり実害が大きい
- セキュリティリスクが高い

---

## 4. 修正対応（問題がある場合）

レビューで指摘された問題を修正します。

### 4.1 修正手順

#### 1. 指摘事項を確認
- Critical/Major/Minorの分類を確認
- 優先度に基づいて対応計画を立てる

#### 2. 修正を実施

```bash
# 修正作業
git add .
git commit -m "fix: レビュー指摘事項を修正

- Critical: データベーススキーマ不一致を修正
- Major: エラーハンドリングを追加

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
git push
```

#### 3. 再レビュー依頼
- PR更新後、再度code-reviewer サブエージェント にレビュー依頼
- すべてのCritical/Major問題が解決されるまで繰り返す

#### 4. 修正内容の報告（推奨）

PRコメントで修正内容を報告：

```markdown
## ✅ レビュー指摘事項を修正しました

### 修正内容
- 修正1: 具体的な内容
- 修正2: 具体的な内容

修正コミット: <commit-hash>
```

### 4.2 修正完了まで繰り返し

- 「修正 → push → code-reviewer サブエージェント レビュー」を繰り返す
- すべての指摘が解決されたらマージ可能

### 4.3 レビューコメントの対応

**優先度の判断**

- **Critical（必須対応）** 🔴: セキュリティ、バグ、データ破損のリスク
- **Major（推奨対応）** 🟠: パフォーマンス、保守性の大幅改善
- **Minor（検討）** 🟡: より良い実装方法の提案

**返信のガイドライン**

1. **対応した場合**
   ```
   ご指摘ありがとうございます。
   [修正内容の説明]
   コミット: [コミットハッシュ]
   ```

2. **対応しない場合**
   ```
   ご提案ありがとうございます。
   [対応しない理由]
   今回は[代替案]で進めさせていただきます。
   ```

3. **質問がある場合**
   ```
   ご指摘の件について確認させてください。
   [具体的な質問]
   ```

---

## 5. GitHub Issue作成（必要に応じて）

レビューで指摘された問題のうち、すぐに対応できない項目はIssue化します。

### 5.1 Issue作成コマンド

```bash
mcp__github__create_issue を使用:
- owner: "ShigaRyunosuke10"
- repo: "nissei"
- title: "[Critical/Major/Minor] 問題の要約"
- body:
  - 問題概要
  - 発生原因
  - 必須対応（Critical/Majorのみ）
  - 優先度
  - 関連PR
- labels: ["bug", "priority: high/medium/low"]
```

**参考**: [ISSUE_GUIDELINES.md](./ISSUE_GUIDELINES.md)

---

## 6. マージ実行

### 6.1 マージ条件

- ✅ レビュー結果が「マージ可」
- ✅ **Critical問題がゼロ**
- ✅ バックエンドのセキュリティ対策が適切
- ✅ Major問題がIssue化済み（または修正済み）

### 6.2 マージ前の最終確認

```bash
# PR状態を確認
mcp__github__get_pull_request
  owner: "ShigaRyunosuke10"
  repo: "nissei"
  pullNumber: <PR番号>

# 確認項目:
# - mergeable: true
# - レビューが承認済み（マージ可）
# - すべてのCritical問題が解決済み
```

### 6.3 mainブランチへマージ

```bash
# MCP GitHub APIを使用
mcp__github__merge_pull_request
  owner: "ShigaRyunosuke10"
  repo: "nissei"
  pullNumber: <PR番号>
  merge_method: "squash"  # 推奨
  commit_title: "feat: <変更内容の要約> (#PR番号)"
  commit_message: "
<詳細な変更内容>

主な変更:
- 変更点1
- 変更点2
- 変更点3

レビュー実施済み（code-reviewer サブエージェント）: マージ可
- セキュリティ: <評価>
- 今後の改善点: Issue #XX, #YY で管理予定
"
```

### 6.4 マージ後のクリーンアップ（任意）

```bash
# ローカルブランチ削除
git checkout main
git branch -d <ブランチ名>

# リモートブランチ削除
git push origin --delete <ブランチ名>
```

---

## 7. docs/ ディレクトリの更新確認（マージ後必須）

⚠️ **重要**: **PR作成→レビュー→マージまでを1セットの作業として完了させる**
- PRが溜まると干渉したり競合の原因になるため、必ずマージまで完了させる
- マージ後は必ず docs/ の更新が必要か確認する

### 7.1 確認が必要な変更

- データベーススキーマ変更（テーブル追加・カラム変更など）
- API エンドポイント追加・変更（リクエスト/レスポンス形式変更）
- 環境変数の追加・変更
- 新機能の追加（アーキテクチャへの影響）
- 設定ファイルの変更

### 7.2 更新対象ドキュメント

- **[docs/DATABASE.md](../docs/DATABASE.md)**: データベーススキーマ定義
- **[docs/API.md](../docs/API.md)**: API エンドポイント仕様
- **[docs/SETUP.md](../docs/SETUP.md)**: 環境構築手順
- **[docs/ARCHITECTURE.md](../docs/ARCHITECTURE.md)**: システムアーキテクチャ

### 7.3 更新フロー

```bash
# 1. 変更内容を確認し、docs/ 更新が必要か判断
# 2. 必要な場合は新しいブランチを作成
git checkout main
git pull
git checkout -b docs-update-<内容>

# 3. ドキュメントを更新
# 4. コミット・push・PR作成
# 5. code-reviewer サブエージェント レビュー → マージ（通常フロー）
```

---

## 8. レビュー履歴の記録

マージ後、`docs/PR_REVIEW_HISTORY.md` を更新します。

### 8.1 記録内容

```markdown
## PR #XX: [タイトル]

**マージ日時**: 2025-10-02
**レビュアー**: code-reviewer サブエージェント
**判定**: [マージ可/マージ不可]

### 変更内容
[主要な変更点のリスト]

### レビュー結果

#### 問題点

**Critical（致命的）** 🔴
[致命的な問題のリスト]

**Major（重要）** 🟠
[重要な問題のリスト]

**Minor（軽微）** 🟡
[軽微な問題のリスト]

#### 良い点
[良かった点のリスト]

#### 総合評価
[マージ可否の判断理由]

### 今後のアクションアイテム

**Priority: High（優先度：高）**
- [ ] Issue #XX: Critical問題の修正

**Priority: Medium（優先度：中）**
- [ ] Issue #YY: Major問題の修正

**Priority: Low（優先度：低）**
- [ ] Issue #ZZ: Minor問題の修正

### マージ詳細
- **マージコミット**: [commit SHA]
- **マージ方法**: squash merge
- **ブランチ**: [branch名] → main
```

---

## 9. セルフレビュー（レビュー前）

PR作成前に自分でチェック：

- [ ] 変更内容を再確認
- [ ] 不要なコメントやデバッグコードを削除
- [ ] `console.log()` や `print()` を削除
- [ ] フォーマットが統一されている
- [ ] 不要なファイルが含まれていない
- [ ] `.gitignore` が適切に設定されている
- [ ] コミットメッセージが [COMMIT_GUIDELINES.md](./COMMIT_GUIDELINES.md) に準拠している

---

## 実施例

### PR #22: 管理者パネルと工数入力の改善

1. **PR作成**: feat-admin-panel-and-worklog-improvements → main
2. **code-reviewer サブエージェント レビュー**: マージ可（条件付き）
   - Major問題3件（JWT改ざん対策、URL推測、エラーハンドリング）
   - Minor問題5件
3. **評価**: バックエンドで適切に保護されており、実害は限定的と判断
4. **マージ**: squash mergeで実行（コミット: 29d8b066）
5. **記録**: `docs/PR_REVIEW_HISTORY.md` に詳細を記録
6. **アクションアイテム**: 今後のIssueとして8件を整理

### PR #21, #20: マージ不可（Critical問題あり）

1. **PR作成**: 工数入力機能の改修
2. **code-reviewer サブエージェント レビュー**: マージ不可
   - **Critical問題**: データベーススキーマ不一致によるデータ損失
3. **Issue作成**: Issue #23, #24 を作成
4. **対応**: Issue修正後に再レビュー → マージ

---

## 注意事項

- ⚠️ **mainブランチへの直接コミットは絶対禁止**
- ⚠️ **PR作成直後に必ずcode-reviewer サブエージェント レビューを依頼**
- ⚠️ **Critical問題が存在する場合は絶対にマージしない**
- ⚠️ **セキュリティリスクが高い場合は追加レビューを実施**
- ⚠️ **Major問題は必ずIssue化またはマージ前に修正**
- ⚠️ **レビュー履歴は必ず `docs/PR_REVIEW_HISTORY.md` に記録**
- ⚠️ **PR作成→レビュー→マージまでを1セットの作業として完了させる**（PRを溜めない）
- ⚠️ **マージ後は必ず docs/ の更新が必要か確認する**

---

## 関連ドキュメント

- [WORKFLOW.md](./WORKFLOW.md): 開発ワークフロー全体
- [COMMIT_GUIDELINES.md](./COMMIT_GUIDELINES.md): コミットメッセージガイドライン
- [ISSUE_GUIDELINES.md](./ISSUE_GUIDELINES.md): Issue作成ガイドライン
- [TESTING.md](./TESTING.md): テストガイドライン
- [NAMING_CONVENTIONS.md](./NAMING_CONVENTIONS.md): 命名規則
- [../docs/PR_REVIEW_HISTORY.md](../docs/PR_REVIEW_HISTORY.md): 過去のレビュー履歴
