# セッション管理ガイドライン

**バージョン**: 1.0
**最終更新**: 2025-10-08

## 📋 目的

- セッション間の引き継ぎを円滑化
- コンテキスト制限到達を回避
- 作業の完全性を担保
- AI側から適切なタイミングでセッション切り替えを提案

---

## ⏰ セッション切り替えタイミング

### 🔴 必須切り替えタイミング（Must）

AI側が**必ず**セッション切り替えを提案すべき状況：

#### 1. コンテキスト使用量が70%到達時

**判断基準**:
```
現在のトークン使用量 / 総トークン数 ≥ 0.7
例: 140,000 / 200,000 = 70%
```

**提案タイミング**:
- 70%到達後、次の作業完了時点
- 作業途中で70%を超えても、現在の作業は完了させる

**提案文例**:
```
現在のコンテキスト使用量が70%（140,000/200,000トークン）に達しました。
次の区切りでセッションを終了することを推奨します。

現在の作業（Issue #XX）を完了後、セッションを区切りますか？
```

#### 2. Phase完了時

**判断基準**:
- Phase 3完了時
- Phase 4完了時
- など、大きなマイルストーン到達時

**提案文例**:
```
Phase 3が完了しました。

Phase 4開始前にセッションを区切ることを推奨します。
理由：
- 大きな区切りポイント
- 次Phaseの要件確認が必要
- コンテキストをリセットして新たな気持ちで開始

セッションを区切りますか？
```

#### 3. 複雑な変更を伴うPRマージ後

**判断基準**:
- データベーススキーマ変更
- 複数ファイルにまたがる大規模リファクタリング
- 新機能追加（Phase内の主要機能）

**提案文例**:
```
PR #XX（データベーススキーマ変更）がマージされました。

セッションを区切ることを推奨します。
理由：
- 大規模な変更が完了
- 次の作業開始前にマイグレーション状態を確認すべき
- コンテキストをリセットして次の作業に集中

セッションを区切りますか？
```

---

### 🟡 推奨切り替えタイミング（Should）

AI側が**状況に応じて**セッション切り替えを提案すべき状況：

#### 4. 作業時間が2時間超過時

**判断基準**:
- セッション開始から2時間経過
- または、連続作業が2時間超過

**提案文例**:
```
現在のセッションは2時間超過しています。

セッションを区切ることを推奨します。
理由：
- 長時間セッションは引き継ぎが困難
- 疲労による判断ミスのリスク増加

セッションを区切りますか？
```

#### 5. 複数PRマージ完了時

**判断基準**:
- 2つ以上のPRをマージ完了
- または、複数Issue完了

**提案文例**:
```
PR #XX, #YYの2つがマージされました。

セッションを区切ることを推奨します。
理由：
- 複数の作業が完了（自然な区切りポイント）
- 残りのIssueは次セッションで集中対応可能
- コンテキスト使用量: 62%（まだ余裕あり）

選択肢：
A. セッションを区切る（推奨）
B. 残りのIssueも続行する
```

#### 6. 方針転換時

**判断基準**:
- Minor Issue対応 → Phase開始
- リファクタリング → 新機能実装
- バックエンド作業 → フロントエンド作業

**提案文例**:
```
Minor Issue対応が完了しました。次はPhase 4開始です。

セッションを区切ることを推奨します。
理由：
- 作業の性質が大きく変化
- Phase 4の要件確認が必要
- 新しい視点で取り組むべき

セッションを区切りますか？
```

---

### 🟢 任意切り替えタイミング（May）

AI側が**必要に応じて**セッション切り替えを提案してもよい状況：

#### 7. ユーザーからの明示的な要求

**判断基準**:
- ユーザーが「一旦ここで区切りたい」等と発言

**対応**:
- 即座にセッション終了準備を開始

---

## 📝 セッション終了時の必須作業

AI側が実施すべき作業：

### 1. TODOリストの整理

```
TodoWrite:
- 完了したTODOを`completed`に
- 未完了のTODOを`pending`に
- 次セッション用のTODOは記載しない（混乱を避ける）
```

### 2. Git状態の確認・整理

```bash
# ブランチ確認
git branch

# クリーン状態確認
git status

# 必要に応じてmainに戻る
git checkout main
git pull
```

### 3. next_session_prompt.md の作成（最優先）

**⚠️ 必須**: ユーザーからセッション切り替え指示があった場合、必ず作成

```bash
# ファイル作成
Write: next_session_prompt.md
```

**記載内容**:
1. **前セッション完了内容**
   - 実装完了機能
   - PRマージ状況
   - ドキュメント更新内容

2. **次セッションの作業**
   - 優先タスク
   - 残タスク詳細
   - その他の選択肢

3. **重要な注意事項**
   - セッション開始時の必須フロー（Serenaメモリ読み込み等）
   - ブランチ状況
   - 設定ファイル変更

4. **技術的メモ**
   - 実装パターン
   - 既知の問題
   - 参考情報

5. **次セッション開始コマンド例**

**テンプレート**: [next_session_prompt.md](../../next_session_prompt.md)参照

### 4. セッション引き継ぎ情報の作成（オプション）

**Serenaメモリに記録**（next_session_prompt.mdの補完として）:
- `.serena/memories/session_handover.md`を更新
- 次セッションで自動読み込み

**内容**:
- 前セッション完了内容
- 次セッション実施事項
- Git状態
- 注意事項

**注**: next_session_prompt.mdが存在する場合、session_handover.mdは省略可

### 5. 次セッション用プロンプトの提示

**テンプレート**:
```markdown
プロジェクトを進めよう。

[次セッションの目標を1-2行で記載]
```

**良い例**:
```
プロジェクトを進めよう。

残存Minor Issue（2件）を完了させてからPhase 4に進みます。
```

**悪い例**（詳細すぎる）:
```
プロジェクトを進めよう。

Issue #64の変数名を以下のように変更してください：
- text → ocr_extracted_text（行番号83）
...
```

### 6. Serenaメモリ更新の指示（次セッション開始時）

**提示文例**:
```
次セッション開始時、以下のSerenaメモリを更新してください：

完了した作業:
- Issue #58: 機種シリーズ抽出ロジックをバックエンドに統一（PR #75マージ）

未完了の作業:
- Issue #64: 変数名の具体化（次セッションで対応）
- Issue #59: HTTPステータスコードの適切な設定（次セッションで対応）
```

---

## 🔄 次セッション開始時の必須フロー

AI側が実施すべき標準フロー：

### ステップ0: next_session_prompt.md の確認（最優先）

**⚠️ 重要**: セッション開始時、まず`next_session_prompt.md`の存在を確認

```bash
# ファイル存在確認
ls next_session_prompt.md 2>/dev/null || echo "ファイルなし"
```

**ファイルが存在する場合**:
1. `next_session_prompt.md`を読み込み
2. 記載内容に従って作業開始
3. Serenaメモリ読み込みは`next_session_prompt.md`の指示に従う

**ファイルが存在しない場合**:
- 以下のステップ1～4を実施（標準フロー）

### ステップ1: Serenaメモリ読み込み（最重要）

```
mcp__serena__activate_project
mcp__serena__read_memory("current_issues_and_priorities.md")
mcp__serena__read_memory("session_handover.md")  # 存在する場合
```

**session_handover.mdが存在しない場合**:
- `phase_progress.md`や`implementation_status.md`から状況把握

### ステップ2: Git状態確認

```bash
git branch
git status
git log -1
```

### ステップ3: 前セッション完了内容の確認

- PRマージ状態
- Issue状態
- 引き継ぎ事項

### ステップ4: 作業開始

- ユーザーに確認せず、引き継ぎ情報の指示に従って作業開始

---

## 📊 セッション切り替え提案フォーマット

AI側が使用すべき提案フォーマット：

### パターンA: 必須切り替え（Must）

```markdown
## 🔴 セッション切り替えを推奨します

**理由**: [コンテキスト70%到達 / Phase完了 / 複雑なPRマージ]

**現在の状況**:
- 完了: [完了した作業]
- 未完了: [残りの作業]
- コンテキスト使用量: XX%

**次セッションで実施**:
1. [作業1]
2. [作業2]

セッションを区切りますか？
```

### パターンB: 推奨切り替え（Should）

```markdown
## 🟡 セッション切り替えを推奨します

**理由**: [複数PRマージ完了 / 作業時間2時間超過 / 方針転換]

**現在の状況**:
- 完了: [完了した作業]
- 未完了: [残りの作業]
- コンテキスト使用量: XX%

**選択肢**:
A. セッションを区切る（推奨）
   - 理由: [具体的な理由]
B. このまま続行
   - リスク: [具体的なリスク]

どちらにしますか？
```

---

## ⚠️ 重要な注意事項

### AI側が守るべきルール

1. **提案は明確に**
   - 曖昧な表現を避ける
   - 「セッションを区切りますか？」と明確に質問

2. **理由を必ず説明**
   - なぜ今区切るべきか
   - 続行した場合のリスクは何か

3. **選択肢を提示**
   - Must以外は、A/B選択肢を提示
   - ユーザーに判断を委ねる

4. **引き継ぎ情報を必ず作成**
   - session_handover.mdは必須
   - 次セッションで迷わないように

5. **次セッション開始時は自律的に**
   - session_handoverの指示に従って作業開始
   - ユーザーに「何をしますか？」と聞かない

---

## 📂 関連ドキュメント

- [ai-rules/nissei/WORKFLOW.md](../nissei/WORKFLOW.md) - nissei固有のセッション運用
- [ai-rules/common/DOCUMENT_CONSISTENCY.md](./DOCUMENT_CONSISTENCY.md) - ドキュメント整合性確認
- [CLAUDE.md](../../CLAUDE.md) - トップレベル設定

---

## 📝 更新履歴

- **2025-10-08**: 初版作成（セッション管理ガイドライン策定）
